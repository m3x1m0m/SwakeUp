/////////////////////////////////////////////////////////////////////////////////
// 
//
// Author:				Maximilian Stiefel
// Last Modification:	19.05.2017
/////////////////////////////////////////////////////////////////////////////////

/////////////////////////////////////////////////////////////////////////////////
// Includes
/////////////////////////////////////////////////////////////////////////////////
#include <avr/io.h>
#include "../drivers/host/pid.h"
#include "voltagecntr.h"
#include "../../util/fixedpoint.h"
#include "../drivers/host/adc.h"
#include "../drivers/host/pwm.h"
#include "../../modules/log.h"
#include "../defines.h"

LOG_INIT("OLED");

/////////////////////////////////////////////////////////////////////////////////
// Global variables
/////////////////////////////////////////////////////////////////////////////////
mycontroller_t oledController;

uint16_t stupid()
{
	return 10+10;
}

void stupid2(uint16_t x)
{
}


/////////////////////////////////////////////////////////////////////////////////
// Init controller
/////////////////////////////////////////////////////////////////////////////////
void initController(void)
{
	oledController.kd = KD;
	oledController.ki = KI;
	oledController.kp = KP;
	oledController.getSensorVal = &getVal_ADCOLED;
	oledController.setActuatorVal = &setDutyCycle_PWMOLED;
	oledController.enabled = 0;												// Keep disabled
	add_Controller(&oledController);
}

/////////////////////////////////////////////////////////////////////////////////
// Enable controller
/////////////////////////////////////////////////////////////////////////////////
void enableController(void)
{
	oledController.enabled = 1;	
}

/////////////////////////////////////////////////////////////////////////////////
// Disable controller
/////////////////////////////////////////////////////////////////////////////////
void disableController(void)
{
	oledController.enabled = 0;
}

/////////////////////////////////////////////////////////////////////////////////
// Set voltage
/////////////////////////////////////////////////////////////////////////////////
void setVoltage(uint16_t voltage)
{
	uint16_t setpoint;
	myfixedpoint32_t uoledCounts = 0;
	myfixedpoint32_t voltageAtADC = 0;
	
	voltageAtADC = fixedPt_mul( FROMINT(voltage), FROMFLOAT(VOLTAGEDIV_GAIN10E6) );								// Voltage divider: VADC = VOLED R2/(R1+R2)			
	uoledCounts = fixedPt_div( voltageAtADC, FROMFLOAT(VPERCOUNT_GAIN10E6) );									// Convert to counts: VADC / VPERCOUNT
	oledController.setPoint = TOUINT16T(uoledCounts);
}