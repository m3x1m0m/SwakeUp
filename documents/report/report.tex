%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Author:      Maximilian Stiefel
%% Date:        06.03.2017
%% University:  Uppsala Universitet
%% Department:  Institutionen fÃ¶r informationsteknologi 
%% Course:      Microcontroller Programming
%% Project:     Swakeup
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\documentclass{report}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Preamble
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% Encoding of the input
\usepackage[utf8x]{inputenc}
% Geometry stuff
\usepackage[head=24pt,a4paper,lmargin={2.5cm},rmargin={2.5cm},tmargin={2.5cm},
bmargin={2.5cm}]{geometry}
% For graphics
\usepackage{graphicx}
% For code highlighting
\usepackage{minted}
% For shaded
\usepackage{xcolor}
\usepackage{framed}
\definecolor{shadecolor}{gray}{0.9}

% For math
\usepackage{amssymb}

\setlength{\parindent}{0em} 

% For title formatting 
\usepackage{titlesec} 

\titleformat%
{\chapter}%
[block]%
{\bfseries\Huge}%
{\thechapter\hspace{1cm}}%
{0pt}%
{\bfseries\Huge}%

% For SI units.
\usepackage{siunitx}

% Input definition macros
\input{mydefs.tex}

\usepackage{hyperref}
\hypersetup{
	plainpages=false,
	unicode=false,
	pdftoolbar=true,
	pdfmenubar=true,
	pdffitwindow=false,
	pdfstartview={FitH},
	pdftitle={\mytitle},
	pdfauthor={\myauthora ,\space\myauthorb ,\space\myauthorc},
	pdfsubject={\mytypeofwork\space\myduedate},
	pdfcreator={\myauthora ,\space\myauthorb ,\space\myauthorc},
	pdfproducer={\myauthora ,\space\myauthorb ,\space\myauthorc},
	pdfkeywords={\mykeywords},
	pdfnewwindow=true,
	pdfborder={0 0 0},
	colorlinks=false,
	linkcolor=black,
	citecolor=black,
	filecolor=black,
	urlcolor=cyan
}	

\newcommand{\newpar}{\vspace{1em}\\}

\usepackage{amsmath}

% For PDFs
\usepackage{pdfpages}

% Header and footer
\usepackage{fancyhdr}
\lhead{\ifnum\value{chapter}>0 \includegraphics[width=1cm]{./fig/uppsla_university} \fi}
\chead{}
\rhead{\ifnum\value{chapter}>0 {\rightmark}\\\textcolor{gray}{\leftmark} \fi}
\lfoot{}
\cfoot{\ifnum\value{chapter}>0 \thepage \fi}
\rfoot{}
\setlength{\headheight}{1cm}


\begin{document}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Titlepage
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\input{titlepage.tex}

\newcounter{roman}
\pagenumbering{Roman}

\pagestyle{fancy}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% TOC etc.
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\tableofcontents
\listoffigures
\newpage
\listoftables

\newpage
\setcounter{roman}{\value{page}}
\pagenumbering{arabic}
\setcounter{page}{1}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Introduction
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\chapter{Introduction}
\label{chap:intro}
\section{Idea}
\label{sec:idea}
\input{./doc/idea.tex}
\section{Sytem Overview}
\label{sec:system}
\input{./doc/overview.tex}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Hardware
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\chapter{Hardware}
\label{chap:hardware}
\section{Logic Board}
\label{sec:logic}
\input{./doc/logic.tex}
\section{Power Board}
\label{sec:power}
\input{./doc/power.tex}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Software
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\chapter{Software}
\label{chap:software}
In order to facilitate all the functionality, code had to be written. Because the system is quite complex with many different functions, a good and clear structure has to be realized. Much of the development time has been invested in the writing and testing of underlying code which don't have a direct result for the finalized product. In the following sub-chapters this system will be described, and explained why certain choices and compromises have been made.
\section{Code Structure} 
\label{sec:code_structure}
\input{./doc/code_structure.tex}
\section{Operating System}
\label{sec:os}
\input{./doc/os.tex}
\section{Realization}
\label{sec:realization}
\input{./doc/realization.tex}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Satus Quo and Outlook
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\chapter{Status Quo and Outlook}
\label{chap:status}
\section{What works? What does not work?}
\label{sec:what}
\input{./doc/works.tex}
\section{Outlook}
\label{sec:outlook}
\input{./doc/outlook.tex}

\clearpage
\pagenumbering{Roman}
\setcounter{page}{\value{roman}}
\pagestyle{empty}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Appendix
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\appendix
% Introduce new geometry to be able to have more space for appendix
\newgeometry{lmargin={2.5cm},rmargin={2.5cm},tmargin={0cm},bmargin={1,5cm}}
\includepdf[pages={1},scale=0.8,pagecommand=\chapter{Schematics Power Board}\label{append:power}]{./fig/power.pdf}
\includepdf[pages={2-},scale=0.8,pagecommand={}]{./fig/power.pdf}
\chapter{USART interrupt generation}
\label{append:usartinterruptgen}
\begin{minted}[baselinestretch=1, fontsize=\small, linenos,frame=single,framesep=5pt]{C}
#define USARTRXCISR(NAME, PORT, USART_ID, REC_FC)            \
ISR(NAME##_RXC_vect) {                             \
	uint8_t read = PORT.DATA;                    \
	if (writeInBuf(read, &PORT)) {               \
	REC_FC(read);                                   \
	uint8_t i = 0;                              \
	for (; i < UART_MAX_DELIMITERS; i++) {      \
		if (delimiters[USART_ID][i].delimiter != 0) {  \
			delimiters[USART_ID][i].length++;          \
			if (read == delimiters[USART_ID][i].delimiter) {   \
				delimiters[USART_ID][i].port = &PORT;       \
				event_fire(&EVENT_UART_DELIMITER,	\
				SYSTEM_ADDRESS_CAST (&delimiters[USART_ID][i])); \
				}   \
			}   \
		}   \
	} else {/*buffer full */    \
		CP_PORT.CTRLA &= ~(USART_RXCINTLVL_LO_gc);  \
	}   \
}

#define USARTDREISR(NAME, PORT, USART_ID)\
ISR(NAME##_DRE_vect) {             \
	uint8_t size = uartStatus[USART_ID].outBuffer_size;    \
	if (size > 0) { \
		if (softlock(USART_ID)) {\
			uint8_t tail = uartStatus[USART_ID].outBuffer_tail;\
			PORT.DATA = outBuffer[USART_ID][tail];  \
			uartStatus[USART_ID].outBuffer_size--; \
			tail++; \
			if (tail >= UART_MAX_OUT_BUFFER) tail = 0;\
			uartStatus[USART_ID].outBuffer_tail = tail;\
			unlock(USART_ID);  \
		}\
	} else {\
		sending[USART_ID] = 0;\
		PORT.CTRLA &= ~(USART_DREINTLVL0_bm);\
	}\
}
\end{minted}
\end{document}
